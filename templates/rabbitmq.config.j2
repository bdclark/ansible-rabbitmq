[
{% if rabbitmq_management_ssl_enabled %}
  {rabbitmq_management, [
    {listener, [
      {port, {{ rabbitmq_management_ssl_port }}},
      {ssl, true},
      {ssl_opts, [
        {cacertfile, "/etc/rabbitmq/ssl/cacert.pem"},
        {certfile, "/etc/rabbitmq/ssl/cert.pem"},
        {keyfile, "/etc/rabbitmq/ssl/key.pem"}
      ]}
    ]}
  ]},
{% else %}
  {rabbitmq_management, [
    {listener, [
      {port, {{ rabbitmq_managment_port }}}
    ]}
  ]},
{% endif %}
  {rabbit, [
{% if rabbitmq_ssl_enabled %}
    {ssl_listeners, [{{ rabbitmq_ssl_port }}]},
    {ssl_options, [
      {cacertfile, "/etc/rabbitmq/ssl/cacert.pem"},
      {certfile, "/etc/rabbitmq/ssl/cert.pem"},
      {keyfile, "/etc/rabbitmq/ssl/key.pem"},
      {verify, {{ rabbitmq_ssl_verify }}},
      {fail_if_no_peer_cert, {{ rabbitmq_ssl_fail_if_no_peer_cert | bool | lower }}}
    ]},
{% endif %}
{% if rabbitmq_cluster_mode == 'auto' %}
    {cluster_nodes, {[
  {% for node in rabbitmq_auto_cluster_nodes %}
      {% if node is mapping %}"{{ node['name'] }}"{% else %}"{{ node }}"{% endif %}{% if not loop.last %},{% endif %}
  {% endfor %}
    ], disc}},
{% endif %}
{% if rabbitmq_cluster_mode and rabbitmq_cluster_mode | length > 1 %}
    {cluster_partition_handling,{{ rabbitmq_cluster_partition_handling }}},
{% endif %}
{% if rabbitmq_disk_free_limit_relative %}
    {disk_free_limit, {mem_relative, {{ rabbitmq_disk_free_limit_relative }}}},
{% endif %}
{% if rabbitmq_disk_free_limit and rabbitmq_disk_free_limit is string %}
    {disk_free_limit, "{{ rabbitmq_disk_free_limit }}"},
{% elif rabbitmq_disk_free_limit and rabbitmq_disk_free_limit is number %}
    {disk_free_limit, {{ rabbitmq_disk_free_limit }}},
{% endif %}
{% if rabbitmq_vm_memory_high_watermark %}
    {vm_memory_high_watermark, {{ rabbitmq_vm_memory_high_watermark }}},
{% endif %}
    {loopback_users, [{% for u in rabbitmq_loopback_users %}<<"{{ u }}">>{% if not loop.last %},{% endif %}{% endfor %}]},
    {default_user, <<"{{ rabbitmq_default_user }}">>},
    {default_pass, <<"{{ rabbitmq_default_pass }}">>}
  ]}
].
